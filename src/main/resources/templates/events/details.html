<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}">

</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class="container">
    <article>
        <h1 th:text="${event.title}"></h1>
        <p th:text="${event.description}"></p>
        <p><strong>Статус:</strong> <span th:text="${event.status}"></span></p>

        <article th:if="${successMessage}" class="secondary" style="margin-bottom: 1rem; border-left: 5px solid green;">
            <span th:text="${successMessage}"></span>
        </article>
        <article th:if="${errorMessage}" class="secondary" style="margin-bottom: 1rem; border-left: 5px solid red;">
            <span th:text="${errorMessage}"></span>
        </article>
        
        <div th:if="${!hasVoted and currentUser != null and currentUser.role.name() != 'ADMIN' and event.status == 'ACTIVE' and event.closesAt.isAfter(T(java.time.Instant).now())}"
        style="display: flex; justify-content: center;">
        <form method="post" th:action="@{/predictions/make}">
            
            <input type="hidden" name="eventId" th:value="${event.id}">
            
            <h3 style="text-align: center;">Сделайте ваш выбор:</h3>

            <div th:each="opt : ${event.optionsWithStats}" style="margin-bottom: 5px;">
                <label>
                    <input type="radio" name="chosenOptionId" th:value="${opt.optionId}" required>
                    <span th:text="${opt.text}">Текст варианта</span>
                </label>
            </div>
            <button type="submit" style="margin-top: 40px; width: auto; padding: 15px 39px; font-size: 1rem;">Подтвердить выбор</button>
        </form>
        </div>
        
        <div th:unless="${!hasVoted and currentUser != null and currentUser.role.name() != 'ADMIN' and event.status == 'ACTIVE' and event.closesAt.isAfter(T(java.time.Instant).now())}">
            <div th:if="${hasVoted}" style="padding: 20px; border-left: 5px solid #4caf50; border-radius: 8px; text-align: center;">
                <h3>✅ Вы сделали предсказание в этом событии</h3>
                <p>Дождитесь окончания события, чтобы узнать результат.</p>
            </div>
            <div th:unless="${hasVoted or event.status == 'ACTIVE' and event.closesAt.isAfter(T(java.time.Instant).now())}"
                 style="padding: 20px; border-left: 5px solid #FFA500; border-radius: 8px; text-align: center;">
                <h3>⚠️ Событие больше не принимает ставки</h3>
                <p th:if="${event.status != 'ACTIVE'}" th:text="'Статус события: ' + ${event.status}">Статус события</p>
                <p th:if="${event.status == 'ACTIVE' and !event.closesAt.isAfter(T(java.time.Instant).now())}">Время для предсказаний истекло</p>
            </div>
        </div>
        
        <hr>
        <!-- Блок для администратора: кнопки управления событием -->
        <div th:if="${currentUser != null and currentUser.role.name() == 'ADMIN'}">
            
            <h4>Панель управления событием</h4>
            
            <div style="margin-bottom: 10px;">
                <form th:action="@{/events/delete/{id} (id=${event.id})}" th:method="POST"
                      onsubmit="return confirm('Вы уверены, что хотите удалить это событие?')">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="outline" style="background-color: #B22222;">Удалить событие</button>
                </form>
            </div>
            
            <div th:if="${event.status != 'FINISHED'}">
                <h5>Завершить событие</h5>
                <p>Выберите, какой вариант победил. Это действие необратимо!</p>

                <form method="post" th:action="@{/events/{id}/finish(id=${event.id})}">
                    <label>Победивший вариант:
                        <select name="winningOptionId" required>
                            <option value="" disabled selected> Выберите исход </option>
                            <option th:each="opt : ${event.optionsWithStats}"
                                    th:value="${opt.optionId}"
                                    th:text="${opt.text}"></option>
                        </select>
                    </label>
                    <button type="submit" style="background-color: #4caf50 !important; border: none;">Подтвердить результат</button>
                </form>
            </div>
        </div>
    
    
        
        <div th:if="${event.status == 'FINISHED'}" style="margin-top: 20px; padding: 15px; border-left: 5px solid #4caf50; border-radius: 4px; text-align: center;">
            <h3> Событие завершено</h3>
    
        </div>
            <div style="margin-top: 50px;">
            <a href="/events/all" role="button" class="secondary" style="font-size: 0.9rem; padding: 5px 15px;">Назад к списку</a>
        </div>
    </article>
</main>
<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>