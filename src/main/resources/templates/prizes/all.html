<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container">

    <!-- –ë–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Pico/HTML) -->
    <div th:if="${successMessage}">
        <mark th:text="${successMessage}"></mark>
    </div>
    <div th:if="${errorMessage}">
        <mark th:text="${errorMessage}"></mark> <!-- Pico –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç mark –∫–∞–∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -->
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ë–∞–ª–∞–Ω—Å -->
    <hgroup>
        <h1>–†–æ–∑—ã–≥—Ä—ã—à–∏ –ø—Ä–∏–∑–æ–≤</h1>
        <p th:if="${currentUser != null}">
            –í–∞—à –±–∞–ª–∞–Ω—Å: <strong th:text="${currentUser.successfulPredictions}">0</strong> –ø–æ–±–µ–¥
        </p>
    </hgroup>

    <!-- –ü–û–ò–°–ö -->
    <form action="/prizes" method="get" role="search">
        <fieldset role="group">
            <input type="search" name="search" th:value="${searchQuery}" placeholder="–ù–∞–π—Ç–∏ –ø—Ä–∏–∑...">
            <button type="submit">–ò—Å–∫–∞—Ç—å</button>
        </fieldset>
    </form>

    <!-- –§–û–†–ú–ê –ê–î–ú–ò–ù–ê (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É) -->
    <article sec:authorize="hasRole('ADMIN')">
        <header><strong>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</strong></header>
        <form method="post" th:action="@{/prizes/add}" th:object="${addPrizeForm}">
            <div class="grid">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ
                    <input type="text" th:field="*{title}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone 16" required>
                </label>
                <label>–¶–µ–Ω–∞ (–ø–æ–±–µ–¥)
                    <input type="number" th:field="*{ticketPrice}" min="1" required>
                </label>
                <label>–î–∞—Ç–∞ –∏—Ç–æ–≥–∞
                    <input type="datetime-local" th:field="*{drawDate}" required>
                </label>
            </div>
            <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </form>
    </article>

    <hr>

    <!-- –°–ü–ò–°–û–ö –ü–†–ò–ó–û–í -->
    <div class="grid">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏–∑–∞ -->
        <article th:each="prize : ${prizes}">

            <header>
                <strong th:text="${prize.title}">–ù–∞–∑–≤–∞–Ω–∏–µ</strong>
                <br>
                <small th:if="${prize.status.name() == 'OPEN'}">üü¢ –û—Ç–∫—Ä—ã—Ç</small>
                <small th:if="${prize.status.name() == 'CLOSED'}">üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω</small>
            </header>

            <p>–¶–µ–Ω–∞: <span th:text="${prize.ticketPrice}">10</span> –ø–æ–±–µ–¥</p>
            <p>–î–∞—Ç–∞: <span th:text="${#dates.format(prize.drawDate, 'dd-MM HH:mm')}"></span></p>

            <!-- –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω -->
            <div th:if="${prize.status.name() == 'CLOSED'}">
                <hr>
                <strong>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: </strong>
                <span th:if="${prize.winner != null}" th:text="${prize.winner.username}">User</span>
                <span th:if="${prize.winner == null}">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
            </div>

            <!-- –ü–æ–¥–≤–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏ (–ö–Ω–æ–ø–∫–∏) -->
            <footer th:if="${prize.status.name() == 'OPEN'}">

                <!-- –ö–Ω–æ–ø–∫–∏ –Æ–∑–µ—Ä–∞ -->
                <form method="post" th:action="@{/prizes/buy/{id}(id=${prize.id})}" th:if="${currentUser != null}">
                    <!-- –ö–Ω–æ–ø–∫–∞ –ê–∫—Ç–∏–≤–Ω–∞—è (—Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥) -->
                    <button type="submit"
                            th:if="${currentUser.successfulPredictions >= prize.ticketPrice}">
                        –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç
                    </button>

                    <!-- –ö–Ω–æ–ø–∫–∞ –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è (–º–∞–ª–æ –¥–µ–Ω–µ–≥) -->
                    <button disabled
                            th:if="${currentUser.successfulPredictions < prize.ticketPrice}"
                            class="secondary">
                        –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–±–µ–¥
                    </button>
                </form>

                <!-- –ö–Ω–æ–ø–∫–∞ –ê–¥–º–∏–Ω–∞ -->
                <form sec:authorize="hasRole('ADMIN')"
                      th:action="@{/prizes/draw/{id}(id=${prize.id})}" method="post">
                    <button type="submit" class="outline contrast">–†–∞–∑—ã–≥—Ä–∞—Ç—å</button>
                </form>
            </footer>
        </article>
    </div>

    <!-- –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ -->
    <div th:if="${prizes.empty}">
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π.</p>
    </div>

    <!-- –ü–ê–ì–ò–ù–ê–¶–ò–Ø (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü > 1) -->
    <div class="grid" th:if="${totalPages > 1}">
        <a role="button" class="outline secondary"
           th:if="${currentPage > 0}"
           th:href="@{/prizes(page=${currentPage - 1}, search=${searchQuery})}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>

        <div style="text-align: center; align-self: center;">
            <small th:text="${currentPage + 1} + ' / ' + ${totalPages}"></small>
        </div>

        <a role="button" class="outline secondary"
           th:if="${currentPage < totalPages - 1}"
           th:href="@{/prizes(page=${currentPage + 1}, search=${searchQuery})}">
            –í–ø–µ—Ä–µ–¥ ‚Üí
        </a>
    </div>

</main>
<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>